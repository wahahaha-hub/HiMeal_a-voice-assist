<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HiMeal | Advanced AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap');
        
        * {
            font-family: 'Space Grotesk', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        code, pre {
            font-family: 'JetBrains Mono', monospace;
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #06b6d4 0%, #3b82f6 100%);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #0a0f1e;
        }
        
        .sidebar {
            overflow: hidden;
            background: linear-gradient(180deg, #0f172a 0%, #020617 100%);
            box-shadow: 4px 0 24px rgba(6, 182, 212, 0.1);
        }
        .sidebar * {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .tech-grid {
            background-image: 
                linear-gradient(rgba(6, 182, 212, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(6, 182, 212, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .gradient-border {
            position: relative;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            border: 1px solid rgba(6, 182, 212, 0.2);
        }
        
        .glow-text {
            text-shadow: 0 0 20px rgba(6, 182, 212, 0.5);
        }
        
        .message-user {
            background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
            animation: slideInRight 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 4px 24px rgba(6, 182, 212, 0.25);
        }
        
        .message-assistant {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            animation: slideInLeft 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            box-shadow: 0 4px 24px rgba(59, 130, 246, 0.1);
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.3;
            }
        }
        
        @keyframes scan {
            0% {
                transform: translateY(-100%);
            }
            100% {
                transform: translateY(100%);
            }
        }
        
        .recording-pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .history-item {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }
        
        .history-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: linear-gradient(180deg, #06b6d4, #3b82f6);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        
        .history-item:hover::before {
            transform: scaleY(1);
        }
        
        .history-item:hover {
            transform: translateX(6px);
            background: rgba(6, 182, 212, 0.05);
        }
        
        .delete-btn {
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .history-item:hover .delete-btn {
            opacity: 1;
        }
        
        .glassmorphism {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(6, 182, 212, 0.1);
        }
        
        .tech-button {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .tech-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .tech-button:hover::before {
            left: 100%;
        }
        
        /* Markdown Styles */
        .markdown-content {
            line-height: 1.7;
        }
        
        .markdown-content h1 {
            font-size: 1.875rem;
            font-weight: 700;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            color: #06b6d4;
        }
        
        .markdown-content h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 1.25rem;
            margin-bottom: 0.75rem;
            color: #3b82f6;
        }
        
        .markdown-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: #60a5fa;
        }
        
        .markdown-content p {
            margin-bottom: 1rem;
        }
        
        .markdown-content ul, .markdown-content ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .markdown-content li {
            margin-bottom: 0.5rem;
        }
        
        .markdown-content code {
            background: rgba(6, 182, 212, 0.1);
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            color: #06b6d4;
            border: 1px solid rgba(6, 182, 212, 0.2);
        }
        
        .markdown-content pre {
            background: #1e293b;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-bottom: 1rem;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .markdown-content pre code {
            background: transparent;
            padding: 0;
            border: none;
            color: inherit;
        }
        
        .markdown-content blockquote {
            border-left: 4px solid #06b6d4;
            padding-left: 1rem;
            margin-left: 0;
            margin-bottom: 1rem;
            color: #94a3b8;
            font-style: italic;
        }
        
        .markdown-content a {
            color: #06b6d4;
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: border-color 0.3s ease;
        }
        
        .markdown-content a:hover {
            border-bottom-color: #06b6d4;
        }
        
        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        
        .markdown-content th, .markdown-content td {
            padding: 0.75rem;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .markdown-content th {
            background: rgba(6, 182, 212, 0.1);
            font-weight: 600;
            color: #06b6d4;
        }
        
        .markdown-content hr {
            border: none;
            border-top: 1px solid rgba(59, 130, 246, 0.2);
            margin: 1.5rem 0;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-[#020617] via-[#0a0f1e] to-[#020617] text-gray-200 antialiased flex h-screen overflow-hidden tech-grid">
    <!-- Sidebar -->
    <div class="sidebar w-[340px] p-6 overflow-y-auto border-r border-cyan-500/10 flex flex-col custom-scrollbar relative">
        
        <!-- Header -->
        <div class="mb-8 relative">
            <div class="flex items-center mb-3">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center mr-3 shadow-lg shadow-cyan-500/50">
                    <span class="text-2xl">ü§ñ</span>
                </div>
                <div>
                    <h1 class="text-3xl font-bold bg-gradient-to-r from-cyan-400 via-blue-400 to-purple-400 bg-clip-text text-transparent glow-text">
                        HiMeal
                    </h1>
                    <p class="text-xs text-cyan-400/60 font-mono">v0.0.1 | AI System</p>
                </div>
            </div>
            <div class="h-px bg-gradient-to-r from-transparent via-cyan-500/50 to-transparent"></div>
        </div>
        
        <!-- Mode Toggle -->
        <button id="mode-toggle-btn" 
                class="tech-button w-full py-3.5 px-4 mb-4 text-sm font-semibold rounded-lg text-white bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 transition-all duration-300 transform hover:scale-[1.02] shadow-lg shadow-cyan-500/25"
                onclick="toggleInputMode()">
            <span class="mr-2">‚ö°</span> MODE: <span id="mode-text" class="font-mono">TEXT</span>
        </button>

        <!-- New Chat Button -->
        <button class="tech-button w-full py-3.5 px-4 text-left mb-6 text-white font-semibold rounded-lg gradient-border hover:bg-slate-800/50 transition-all duration-300 transform hover:scale-[1.02]" onclick="createNewChat()">
            <span class="mr-2 text-lg">‚ú®</span> NEW SESSION
        </button>
        
        <!-- Search History -->
        <div class="mb-4">
            <input type="text" id="history-search" placeholder="Search sessions..." 
                   class="w-full py-2.5 px-4 bg-slate-900/50 border border-cyan-500/20 text-white rounded-lg text-sm focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all font-mono"
                   oninput="filterHistory()">
        </div>
        
        <!-- History -->
        <div class="history flex-grow overflow-x-hidden custom-scrollbar">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xs font-bold text-cyan-400 uppercase tracking-widest font-mono flex items-center">
                    <span class="mr-2">üìä</span> SESSIONS
                </h3>
                <button onclick="clearAllHistory()" class="text-xs text-red-400 hover:text-red-300 transition-colors font-mono" title="Clear all history">
                    CLEAR
                </button>
            </div>
            <div id="history-list"></div>
        </div>
        
        <!-- Status Indicator -->
        <div class="mt-4 pt-4 border-t border-cyan-500/10">
            <div class="flex items-center justify-between text-xs font-mono">
                <span class="text-cyan-400/60">STATUS</span>
                <div class="flex items-center">
                    <div class="w-2 h-2 bg-green-500 rounded-full mr-2 recording-pulse"></div>
                    <span class="text-green-400">ONLINE</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Chat Area -->
    <div class="main flex-1 flex flex-col overflow-hidden">
        <!-- Chat Header -->
        <div class="chat-header px-8 py-5 border-b border-cyan-500/10 glassmorphism relative overflow-hidden">
            <div class="flex items-center justify-between">
                <h2 class="text-xl font-bold flex items-center">
                    <div class="w-8 h-8 rounded bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center mr-3 shadow-lg">
                        <span>üí¨</span>
                    </div>
                    <span id="topic" class="bg-gradient-to-r from-cyan-400 to-blue-400 bg-clip-text text-transparent font-mono">NEW SESSION</span>
                </h2>
                <div class="text-xs font-mono text-cyan-400/60" id="message-count">0 MESSAGES</div>
            </div>
        </div>
        
        <!-- Messages Area -->
        <div class="flex-1 overflow-y-auto custom-scrollbar px-8 py-6 relative">
            <div id="messages" class="max-w-5xl mx-auto">
                <div class="info gradient-border p-10 rounded-xl text-center shadow-2xl relative overflow-hidden">
                    <div class="scan-line"></div>
                    <div class="text-6xl mb-4">üöÄ</div>
                    <p class="text-2xl font-bold mb-2 bg-gradient-to-r from-cyan-400 to-blue-400 bg-clip-text text-transparent">
                        HIMEAL AI SYSTEM
                    </p>
                    <p class="text-sm text-cyan-400/60 font-mono mb-4">Advanced Conversational Interface</p>
                    <div class="flex items-center justify-center space-x-6 text-xs font-mono text-gray-400">
                        <div class="flex items-center">
                            <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                            <span>READY</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-2 h-2 bg-blue-500 rounded-full mr-2"></div>
                            <span>SECURE</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-2 h-2 bg-purple-500 rounded-full mr-2"></div>
                            <span>ENCRYPTED</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="loading" class="hidden text-center p-8 max-w-5xl mx-auto">
                <div class="inline-flex items-center space-x-2 gradient-border px-8 py-5 rounded-full">
                    <div class="w-2 h-2 bg-cyan-500 rounded-full recording-pulse"></div>
                    <div class="w-2 h-2 bg-blue-500 rounded-full recording-pulse" style="animation-delay: 0.2s"></div>
                    <div class="w-2 h-2 bg-purple-500 rounded-full recording-pulse" style="animation-delay: 0.4s"></div>
                    <span class="ml-3 text-cyan-400 font-mono text-sm">PROCESSING</span>
                </div>
            </div>
            
            <div id="error" class="hidden max-w-5xl mx-auto mt-4 p-4 bg-red-900/30 border border-red-500/50 rounded-xl text-red-400 shadow-lg font-mono text-sm"></div>
        </div>
        
        <!-- Input Area -->
        <div class="input-area px-8 py-5 border-t border-cyan-500/10 glassmorphism relative overflow-hidden">
            <div class="max-w-5xl mx-auto">
                <!-- Text Input -->
                <div id="text-input-area" class="flex flex-col space-y-3">
                    <div class="relative flex items-end gap-2">
                        <textarea id="text-input" placeholder="Enter your message..." 
                                  class="flex-1 p-4 bg-slate-900/50 border border-cyan-500/20 text-white rounded-xl resize-none min-h-[70px] max-h-[200px] focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all shadow-lg font-mono text-sm"
                                  onkeypress="handleKeyPress(event)"></textarea>
                        <button id="send-btn" onclick="sendTextMessage()" disabled 
                                class="tech-button px-6 py-4 bg-gradient-to-r from-cyan-600 to-blue-600 text-white font-bold rounded-xl hover:from-cyan-500 hover:to-blue-500 transition-all duration-300 transform hover:scale-[1.02] disabled:opacity-30 disabled:cursor-not-allowed disabled:transform-none shadow-lg shadow-cyan-500/25 font-mono text-sm whitespace-nowrap">
                            SEND ‚Üí
                        </button>
                    </div>
                </div>
                
                <!-- Voice Input -->
                <div id="voice-input-area" class="hidden">
                    <button id="voice-btn" onclick="toggleVoiceRecording()" 
                            class="tech-button w-full py-7 bg-gradient-to-r from-red-600 to-pink-600 text-white font-bold rounded-xl text-lg hover:shadow-2xl hover:shadow-red-500/30 transition-all duration-300 transform hover:scale-[1.02] disabled:opacity-30 disabled:cursor-not-allowed">
                        <span id="voice-icon" class="text-2xl">üéôÔ∏è</span> <span id="voice-text" class="font-mono">TAP TO SPEAK</span>
                    </button>
                    <div id="voice-status" class="text-center mt-3 text-cyan-400 text-sm font-bold font-mono"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configure marked.js
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, { language: lang }).value;
                    } catch (err) {}
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });

        // Configuration
        const BACKEND_HOST = "localhost";
        const BACKEND_PORT = "8008";
        const TEXT_ENDPOINT = "/reply/text";
        const VOICE_ENDPOINT = "/reply/voice";
        const TEXT_API = `http://${BACKEND_HOST}:${BACKEND_PORT}${TEXT_ENDPOINT}`;
        const VOICE_API = `http://${BACKEND_HOST}:${BACKEND_PORT}${VOICE_ENDPOINT}`;

        // Session State
        let sessions = JSON.parse(localStorage.getItem('sessions')) || {};
        let currentSession = localStorage.getItem('current_session');
        let inputMode = localStorage.getItem('input_mode') || 'Text';
        let processedAudioId = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let mediaStream = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            if (!currentSession || !sessions[currentSession]) {
                currentSession = createNewSession();
                localStorage.setItem('current_session', currentSession);
            }
            
            setInputMode(inputMode, true);
            loadCurrentSession();
            renderHistory();
            updateTextInputListener();
            
            const textarea = document.getElementById('text-input');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 200) + 'px';
            });
        }

        function createNewSession() {
            const id = Date.now().toString();
            const now = new Date();
            // Don't save empty session yet - will save when first message is added
            return id;
        }
        
        function ensureSessionExists(sessionId) {
            if (!sessions[sessionId]) {
                sessions[sessionId] = {
                    id: sessionId,
                    created_at: new Date().toISOString(),
                    topic: "NEW SESSION",
                    messages: []
                };
            }
        }

        function saveSessions() {
            localStorage.setItem('sessions', JSON.stringify(sessions));
        }

        function loadCurrentSession() {
            ensureSessionExists(currentSession);
            document.getElementById('topic').textContent = sessions[currentSession].topic;
            updateMessageCount();
            renderMessages();
        }

        function updateMessageCount() {
            const chat = sessions[currentSession];
            const count = chat.messages.length;
            document.getElementById('message-count').textContent = `${count} MESSAGE${count !== 1 ? 'S' : ''}`;
        }

        function createNewChat() {
            currentSession = createNewSession();
            localStorage.setItem('current_session', currentSession);
            processedAudioId = null;
            loadCurrentSession();
            renderHistory();
        }

        function switchChat(id) {
            currentSession = id;
            localStorage.setItem('current_session', currentSession);
            processedAudioId = null;
            loadCurrentSession();
            renderHistory();
        }

        function deleteChat(id, event) {
            event.stopPropagation();
            if (confirm('DELETE THIS SESSION?')) {
                delete sessions[id];
                saveSessions();
                if (currentSession === id) {
                    currentSession = createNewSession();
                    localStorage.setItem('current_session', currentSession);
                    loadCurrentSession();
                }
                renderHistory();
            }
        }

        function clearAllHistory() {
            if (confirm('DELETE ALL SESSION DATA? THIS ACTION CANNOT BE UNDONE.')) {
                sessions = {};
                currentSession = createNewSession();
                localStorage.setItem('current_session', currentSession);
                saveSessions();
                loadCurrentSession();
                renderHistory();
            }
        }

        function filterHistory() {
            const searchTerm = document.getElementById('history-search').value.toLowerCase();
            const historyItems = document.querySelectorAll('.history-item');
            
            historyItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        }

        function setInputMode(mode, isInit = false) {
            if (!isInit && mode === inputMode) return;

            inputMode = mode;
            localStorage.setItem('input_mode', mode);
            
            const textInputArea = document.getElementById('text-input-area');
            const voiceInputArea = document.getElementById('voice-input-area');
            const modeText = document.getElementById('mode-text');
            
            if (mode === 'Text') {
                textInputArea.classList.remove('hidden');
                voiceInputArea.classList.add('hidden');
                modeText.textContent = 'TEXT';
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                }
            } else {
                textInputArea.classList.add('hidden');
                voiceInputArea.classList.remove('hidden');
                modeText.textContent = 'VOICE';
                requestMicrophoneAccess();
            }
        }

        async function requestMicrophoneAccess() {
            try {
                if (!mediaStream || !mediaStream.active) {
                    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                }
            } catch (e) {
                console.error('Microphone access error:', e);
            }
        }

        function toggleInputMode() {
            const newMode = inputMode === 'Text' ? 'Voice' : 'Text';
            setInputMode(newMode);
        }

        function updateTopic(firstMessageText) {
            const chat = sessions[currentSession];
            if (chat.topic === "NEW SESSION") {
                const cleanText = firstMessageText.trim().toUpperCase();
                chat.topic = cleanText.substring(0, 35) + (cleanText.length > 35 ? "..." : "");
                document.getElementById('topic').textContent = chat.topic;
                saveSessions();
                renderHistory();
            }
        }

        function formatTime(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'NOW';
            if (diffMins < 60) return `${diffMins}M AGO`;
            if (diffHours < 24) return `${diffHours}H AGO`;
            if (diffDays < 7) return `${diffDays}D AGO`;
            return date.toLocaleDateString().toUpperCase();
        }

        function renderMessages() {
            const messagesDiv = document.getElementById('messages');
            const chat = sessions[currentSession];
            
            if (chat.messages.length === 0) {
                messagesDiv.innerHTML = `
                    <div class="info gradient-border p-10 rounded-xl text-center shadow-2xl relative overflow-hidden">
                        <div class="text-6xl mb-4">üöÄ</div>
                        <p class="text-2xl font-bold mb-2 bg-gradient-to-r from-cyan-400 to-blue-400 bg-clip-text text-transparent">
                            HIMEAL AI SYSTEM
                        </p>
                        <p class="text-sm text-cyan-400/60 font-mono mb-4">Advanced Conversational Interface</p>
                        <div class="flex items-center justify-center space-x-6 text-xs font-mono text-gray-400">
                            <div class="flex items-center">
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                                <span>READY</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-2 h-2 bg-blue-500 rounded-full mr-2"></div>
                                <span>SECURE</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-2 h-2 bg-purple-500 rounded-full mr-2"></div>
                                <span>ENCRYPTED</span>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            messagesDiv.innerHTML = chat.messages.map(msg => {
                const isUser = msg.role === 'user';
                const alignment = isUser ? 'justify-end' : 'justify-start';
                const messageClass = isUser ? 'message-user' : 'message-assistant';
                
                // Parse markdown for assistant messages
                const content = isUser ? escapeHtml(msg.content) : marked.parse(msg.content);
                
                return `
                    <div class="flex ${alignment} mb-5">
                        <div class="message ${messageClass} max-w-[80%] p-5 rounded-xl ${isUser ? 'rounded-br-sm' : 'rounded-bl-sm'} relative">
                            <div class="${isUser ? '' : 'markdown-content'}">${content}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function renderHistory() {
            const historyList = document.getElementById('history-list');
            // Filter out empty sessions (sessions with no messages)
            const sortedSessions = Object.entries(sessions)
                .filter(([id, chat]) => chat.messages.length > 0)
                .sort(([,a], [,b]) => b.id - a.id);
            
            if (sortedSessions.length === 0) {
                historyList.innerHTML = '<p class="text-center text-gray-500 text-xs py-4 font-mono">NO SESSIONS</p>';
                return;
            }
            
            historyList.innerHTML = sortedSessions.map(([id, chat]) => {
                const isActive = id === currentSession;
                const activeClasses = isActive ? 'bg-gradient-to-r from-cyan-600/10 to-blue-600/10 border-l-2 border-cyan-500' : '';
                const messageCount = chat.messages.length;
                
                return `
                    <div class="history-item flex items-center justify-between p-3 rounded-lg cursor-pointer transition-all duration-200 mb-2 ${activeClasses} group" onclick="switchChat('${id}')">
                        <div class="flex-1 min-w-0 mr-2">
                            <div class="flex items-center mb-1">
                                <span class="text-sm mr-2">${isActive ? '‚ö°' : 'üìÑ'}</span>
                                <p class="text-xs font-semibold text-gray-200 truncate font-mono">${escapeHtml(chat.topic)}</p>
                            </div>
                            <div class="flex items-center text-[10px] text-cyan-400/60 ml-6 font-mono">
                                <span>${formatTime(chat.created_at)}</span>
                                <span class="mx-2">‚Ä¢</span>
                                <span>${messageCount} MSG</span>
                            </div>
                        </div>
                        <button onclick="deleteChat('${id}', event)" 
                                class="delete-btn text-red-400 hover:text-red-300 p-2 rounded-lg hover:bg-red-500/10 transition-all text-xs font-mono"
                                title="Delete session">
                            ‚úï
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        function updateTextInputListener() {
            const textInput = document.getElementById('text-input');
            const sendBtn = document.getElementById('send-btn');
            textInput.oninput = () => sendBtn.disabled = !textInput.value.trim();
            sendBtn.disabled = !textInput.value.trim();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendTextMessage();
            }
        }

        async function sendTextMessage() {
            const textInput = document.getElementById('text-input');
            const prompt = textInput.value.trim();
            if (!prompt) return;

            ensureSessionExists(currentSession);
            const chat = sessions[currentSession];
            chat.messages.push({ role: "user", content: prompt });
            if (chat.messages.length === 1) updateTopic(prompt);
            saveSessions(); // Save after adding message
            textInput.value = '';
            textInput.style.height = 'auto';
            document.getElementById('send-btn').disabled = true;
            updateMessageCount();
            renderMessages();
            renderHistory(); // Update history after first message

            showLoading(true);
            try {
                const response = await fetch(TEXT_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: prompt, history: chat.messages })
                });
                if (response.ok) {
                    const data = await response.json();
                    const reply = data.assistant_text || '';
                    chat.messages.push({ role: "assistant", content: reply });
                    saveSessions();
                    updateMessageCount();
                    renderMessages();
                } else {
                    throw new Error(`SERVER ERROR: ${await response.text()}`);
                }
            } catch (e) {
                showError(e.message);
            } finally {
                showLoading(false);
            }
        }

        function toggleVoiceRecording() {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        }

        async function startRecording() {
            try {
                if (!mediaStream || !mediaStream.active) {
                    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                }
                
                mediaRecorder = new MediaRecorder(mediaStream);
                audioChunks = [];

                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = processAudio;

                mediaRecorder.start();
                isRecording = true;
                document.getElementById('voice-icon').textContent = '‚èπÔ∏è';
                document.getElementById('voice-text').textContent = 'STOP RECORDING';
                document.getElementById('voice-status').textContent = 'RECORDING...';
                document.getElementById('voice-btn').classList.remove('from-red-600', 'to-pink-600');
                document.getElementById('voice-btn').classList.add('from-gray-700', 'to-gray-800', 'recording-pulse');

            } catch (e) {
                showError('MICROPHONE ACCESS DENIED');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                document.getElementById('voice-icon').textContent = 'üéôÔ∏è';
                document.getElementById('voice-text').textContent = 'TAP TO SPEAK';
                document.getElementById('voice-status').textContent = 'PROCESSING...';
                document.getElementById('voice-btn').classList.add('from-red-600', 'to-pink-600');
                document.getElementById('voice-btn').classList.remove('from-gray-700', 'to-gray-800', 'recording-pulse');
            }
        }

        async function processAudio() {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            
            const audioBytes = await audioBlob.arrayBuffer();
            const uint8Array = new Uint8Array(audioBytes);
            let binary = '';
            for (let i = 0; i < uint8Array.byteLength; i++) {
                binary += String.fromCharCode(uint8Array[i]);
            }
            const b64Audio = btoa(binary);

            const audioId = btoa(String.fromCharCode(...new Uint8Array(audioBytes)));
            if (processedAudioId === audioId) return;

            processedAudioId = audioId;

            ensureSessionExists(currentSession);
            const chat = sessions[currentSession];
            showLoading(true);
            try {
                const response = await fetch(VOICE_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ audio: b64Audio, history: chat.messages })
                });
                if (response.ok) {
                    const data = await response.json();
                    const userText = data.user_text || '';
                    const assistantText = data.assistant_text || '';

                    if (userText) {
                        chat.messages.push({ role: "user", content: userText });
                        if (chat.messages.length === 1) updateTopic(userText);
                    }
                    if (assistantText) {
                        chat.messages.push({ role: "assistant", content: assistantText });
                    }
                    saveSessions();
                    updateMessageCount();
                    renderMessages();
                    renderHistory(); // Update history after first message
                } else {
                    throw new Error(`BACKEND ERROR: ${await response.text()}`);
                }
            } catch (e) {
                showError(`VOICE ERROR: ${e.message}`);
                processedAudioId = null;
            } finally {
                showLoading(false);
                document.getElementById('voice-status').textContent = '';
            }
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = `‚ö†Ô∏è ${message}`;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>